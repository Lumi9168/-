<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>現在の予約状況</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="admin-page">
    <header>
        <h1>現在の予約状況</h1>
        <div class="menu-toggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <nav id="side-menu" class="hidden">
            <ul class="side-menu-main">
                <li><a href="admin.html">管理者メインメニュー</a></li>
                <li><a href="admin-reservations.html">現在の予約状況</a></li>
                <li><a href="admin-damage.html">破損品対応</a></li>
            </ul>
            <ul class="side-menu-bottom">
                <li><a href="index.html">ユーザーメインメニューへ</a></li>
            </ul>
        </nav>
        <div id="overlay" class="hidden" onclick="closeMenu()"></div>
    </header>
    <main>
        <section>
            <h2>現在の予約状況</h2>
            <div id="reservation-section">
                <p>読み込み中...</p>
            </div>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 荷受け予約システム</p>
    </footer>
    <script>
        function toggleMenu() {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('overlay');
            if (window.innerWidth < 768) {
                menu.classList.toggle('hidden');
                overlay.classList.toggle('hidden');
            }
        }
        function closeMenu() {
            const menu = document.getElementById('side-menu');
            const overlay = document.getElementById('overlay');
            if (window.innerWidth < 768) {
                menu.classList.add('hidden');
                overlay.classList.add('hidden');
            }
        }
        window.addEventListener('resize', () => {
            const menu = document.getElementById('side-menu');
            if (window.innerWidth >= 768) {
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        });
        document.addEventListener('DOMContentLoaded', () => {
            const menu = document.getElementById('side-menu');
            if (window.innerWidth >= 768) {
                menu.classList.remove('hidden');
            } else {
                menu.classList.add('hidden');
            }
        });
        document.querySelector('.menu-toggle').addEventListener('click', (event) => {
            event.stopPropagation();
            toggleMenu();
        });
        // 予約一覧取得＆表示＋SMS送信リンク生成
        async function loadReservations() {
            const section = document.getElementById('reservation-section');
            section.innerHTML = '<p>読み込み中...</p>';
            try {
                const res = await fetch('/api/reservations');
                const data = await res.json();
                const reservations = (data.reservations || []);
                if (reservations.length === 0) {
                    section.innerHTML = '<p>現在の予約はありません。</p>';
                    return;
                }
                // 先頭予約を大きく表示
                const first = reservations[0];
                let html = `<div style="border:2px solid #b22222;padding:1em;margin-bottom:1em;background:#fff8f8;position:relative;">
                    <button id="skip-btn" style="position:absolute;top:10px;right:10px;background:#ff9800;color:#fff;border:none;border-radius:5px;padding:0.4em 1em;cursor:pointer;">スキップ</button>
                    <strong>【呼出対象】</strong><br>
                    日付: ${first.date || ''}<br>
                    会社名: ${first.companyName || ''}<br>
                    ドライバー名: ${first.driverName || ''}<br>
                    荷物の概要: <span style="color:#333;">${first.cargoSummary || ''}</span><br>
                    電話番号: ${first.phoneNumber || ''}<br>
                    <button id="call-btn" class="menu-button" style="margin-top:1em;display:inline-block;">呼出</button>
                </div>`;
                // 2件目以降
                if (reservations.length > 1) {
                    html += '<div><strong>以降の予約</strong><ul>';
                    for (let i = 1; i < reservations.length; i++) {
                        const r = reservations[i];
                        html += `<li>${r.date || ''} ${r.companyName || ''} ${r.driverName || ''} ${r.phoneNumber || ''}</li>`;
                    }
                    html += '</ul></div>';
                }
                section.innerHTML = html;
                // 呼出ボタンでSMS送信
                const callBtn = document.getElementById('call-btn');
                if (callBtn && first.phoneNumber) {
                    callBtn.onclick = function(e) {
                        const smsBody = encodeURIComponent('お呼び出しです。順番になりましたので受付までお越しください。');
                        const smsUrl = `sms:${first.phoneNumber}?body=${smsBody}`;
                        if (/Android|iPhone|iPad|iPod/i.test(navigator.userAgent)) {
                            window.location.href = smsUrl;
                        } else {
                            alert('この機能はスマートフォンでご利用ください。');
                        }
                    };
                }
                // スキップボタン機能
                const skipBtn = document.getElementById('skip-btn');
                if (skipBtn && reservations.length > 1) {
                    skipBtn.onclick = async function() {
                        // 先頭予約を2番目に、2番目を先頭に
                        const newList = [reservations[1], reservations[0], ...reservations.slice(2)];
                        try {
                            await fetch('/api/reservations', {
                                method: 'PUT',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ reservations: newList })
                            });
                            loadReservations();
                        } catch (e) {
                            alert('スキップ処理に失敗しました');
                        }
                    };
                } else if (skipBtn) {
                    skipBtn.disabled = true;
                }
            } catch (e) {
                section.innerHTML = '<p style="color:red;">予約情報の取得に失敗しました</p>';
            }
        }
        document.addEventListener('DOMContentLoaded', loadReservations);
    </script>
</body>
</html>
